---
title: Os gráficos que explicam nossos dados (heatmap)
date: 2016-07-09
author: Ítalo Cegatta
tags:
  - readxl
  - dplyr
  - ggplot2
  - ggthemes
  - viridis
categories:
  - Gráficos
thumbnailImage: http://i.imgur.com/6ukFJh0.png
coverImage: http://i.imgur.com/jur9Sh3.png
coverCaption: "Imagem: http://graphics.wsj.com"
thumbnailImagePosition: top
metaAlignment: center
coverMeta: out
---



<p>O heatmap é um gráfico muito útil para identificar padrões, principalmente quando temos muitas variáveis no gráfico. Essencialmente o heatmap necessita de 3 variáveis: uma variável resposta e duas outras variáveis para compor os eixos x e y. Não há restrição quanto ao tipo de variável, qualquer uma delas podem ser quantitativa ou qualitativa. Talvez esse seja o trunfo do heatmap, essa flexbilidade quanto a natureza das variáveis nos permite utilizá-lo em diversos momentos e substituir gráficos mais tradicionais quando eles não dão conta do recado.</p>
<p>Vamos trabalhar com os dados do <a href="http://www.projetotume.com/">Projeto TUME</a>, especificamente com o TUME 0, plantado na Estação Experimental de Itatinga. O TUME é um projeto muito interessante e possui informações importantes sobre plantios de <em>Eucalyptus</em> no Brasil, vale a pena visitar o site e aproveitar o conteúdo disponível.</p>
<p>Vamos primeiro carregar os dados e fazer algumas alterações. Para auxiliar na ordem dos fatores no gráfico vamos adicionar um atributo na coluna <code>Esp</code> informando a ordem crescente das espécies em função da altura dominante. Em seguida, apenas por conveniência, converti a idade dos inventários de meses para anos.</p>
<pre class="r"><code>if (!require(&quot;pacman&quot;)) install.packages(&quot;pacman&quot;)
pacman::p_load(readr, dplyr, ggplot2, ggthemes, viridis)</code></pre>
<pre class="r"><code>dados &lt;- read_csv2(
  &quot;https://github.com/italocegatta/italocegatta.github.io_source/raw/master/content/dados/tume0.csv&quot;
)

# Cria um fator com o atributo para a variável Esp que informa a ordem crescente
# das espécies em função da altura dominante.
dados &lt;- dados %&gt;% 
  mutate(
    Esp = reorder(Esp, Hdom, function(x) max(x)),
    Idade = round(I_meses/12,1)
  )
dados</code></pre>
<pre><code>## # A tibble: 138 x 16
##    N_tume Esp       I_meses Parc_m2 DAPmed DAPsd  Hmed   Hsd  Hdom N_fuste
##     &lt;int&gt; &lt;fct&gt;       &lt;int&gt;   &lt;dbl&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;   &lt;int&gt;
##  1      0 Clone_1        52   1426.  11.4   1.40 16.5   1.30 17.8     1789
##  2      0 Clone_2        52   1426.  10.2   1.40 15.9   1.40 16.6     1662
##  3      0 Clone_3        52   1426.  10.7   1.60 15.0   1.30 16.1     1824
##  4      0 E_bentha~      52   1426.   9.00  2.70  9.80  2.30 13.0     1494
##  5      0 E_botryo~      52   1426.   9.10  4.30 10.8   3.40 15.3     1368
##  6      0 E_camald~      52   1426.   8.30  2.90  8.30  2.30 11.8     1557
##  7      0 E_citrio~      52   1426.   8.00  3.50  8.30  2.80 12.0      954
##  8      0 E_cloezi~      52    929.   7.50  2.50  7.00  2.00  9.60    1367
##  9      0 E_deanei       52   1426.  10.6   2.90 11.3   1.80 13.4     1087
## 10      0 E_dunnii       52   1426.   6.70  3.70  6.10  2.40 10.3      779
## # ... with 128 more rows, and 6 more variables: Sobr &lt;dbl&gt;, G &lt;dbl&gt;,
## #   V &lt;int&gt;, IMA &lt;dbl&gt;, B &lt;int&gt;, Idade &lt;dbl&gt;</code></pre>
<p>Se fizermos a seguinte pergunta: qual gráfico podemos utilizar para mostrar o crescimento da altura dominantes dos materiais? Penso que a resposta rápida seria, um gráfico de linhas! Ok, vamos tentar, veja a Figura <a href="#fig:6-linhas">1</a>.</p>
<pre class="r"><code>ggplot(dados, aes(Idade, Hdom, color = Esp)) +
  geom_line(size=1.5) +
  labs(x = &quot;Idade (anos)&quot;, y = &quot;Altura dominante (m)&quot;) +
  theme_few() +
  scale_color_viridis(
    name = &quot;Materiais genéticos&quot;,
    direction = -1, discrete = T
  ) +
  guides(col = guide_legend(ncol = 1, reverse = TRUE))</code></pre>
<div class="figure"><span id="fig:6-linhas"></span>
<img src="/post/2016-07-09-os-graficos-que-explicam-nossos-dados-heatmap_files/figure-html/6-linhas-1.png" alt="Aumento da altura dominante utilizando gráficos de linhas." width="4000" />
<p class="caption">
Figura  1: Aumento da altura dominante utilizando gráficos de linhas.
</p>
</div>
<p>Muito bem, o gráfico consegue mostar a tendência e o padrão de crescimento. Mas se alguém perguntar sobre o <em>Eucaluptus dunnii</em>, capaz de demorarmos um tempo para encontrar a linha correspondente. Capaz ainda de não conseguirmos distinguir entre uma cor e outra. Essa é uma limitação do gráfico de linhas, quanto temos muitos fatores na legenda fica difícil a distinção entre eles. E quando se tem uma restrição de cor e o gráfico precisa estar em escala de cinza? Esquece! Há quem tente utilizar símbolos ou tipos de traços para distinguir os fatores, mas mesmo assim, não é uma tarefa fácil.</p>
<p>É neste momento que podemos nos aproveitar do heatmap. Agora a intencidade de cor indica a variável resposta (Figura <a href="#fig:6-heatmap-cont">2</a>). Veja que fica mais fácil acompanhar o crescimento de uma espécies em especial.</p>
<pre class="r"><code>ggplot(dados, aes(factor(Idade), Esp, fill = Hdom)) +
  geom_tile() +
  labs(x = &quot;Idade (anos)&quot;, y = &quot;Materiais genéticos&quot;) +
  theme_few() +
  scale_fill_viridis(name = &quot;Altura dominante (m)&quot;, direction = -1) +
  guides(col = guide_legend(reverse = TRUE))</code></pre>
<div class="figure"><span id="fig:6-heatmap-cont"></span>
<img src="/post/2016-07-09-os-graficos-que-explicam-nossos-dados-heatmap_files/figure-html/6-heatmap-cont-1.png" alt="Aumento da altura dominante utilizando heatmap com escala de cor contínua." width="4000" />
<p class="caption">
Figura  2: Aumento da altura dominante utilizando heatmap com escala de cor contínua.
</p>
</div>
<p>Se for do interesse controlar a escala de cor em intervalos e classes, a alteração é simples (Figura <a href="#fig:6-heatmap-discr">3</a>). Se reduzirmos as classes de cor, perdemos resolução na escala da variável resposta. Dependendo do objetivo do gráfico isso pode ser bom ou ruim. Neste caso, escolhi intervalos de 2 metros, pois achei mais adequado.</p>
<pre class="r"><code>ggplot(dados, aes(factor(Idade),
       Esp, fill = cut(Hdom, breaks = seq(0, 40, 2)))) +
 geom_tile() +
 labs(x = &quot;Idade (anos)&quot;, y = &quot;Materiais genéticos&quot;) +
 theme_few() +
 scale_fill_viridis(
   name = &quot;Altura dominante (m)&quot;,
   discrete = T, direction = -1
 ) +
 guides(col = guide_legend(reverse = TRUE))</code></pre>
<div class="figure"><span id="fig:6-heatmap-discr"></span>
<img src="/post/2016-07-09-os-graficos-que-explicam-nossos-dados-heatmap_files/figure-html/6-heatmap-discr-1.png" alt="Aumento da altura dominante utilizando heatmap com escala de cor discreta." width="4000" />
<p class="caption">
Figura  3: Aumento da altura dominante utilizando heatmap com escala de cor discreta.
</p>
</div>
<p>Se quisermos deixar explícito o valor da variável resposta podemos indicá-la no gráfico, como na Figura <a href="#fig:6-heatmap-discr-label">4</a>. Eu particularmente acho que fica muito poluído, mas em alguns casos pode ser interessante.</p>
<pre class="r"><code>ggplot(dados, aes(factor(Idade),
       Esp, fill = cut(Hdom, breaks = seq(0, 40, 2)))) +
 geom_tile() +
 geom_text(aes(label = Hdom), color = &quot;white&quot;) +
 labs(x = &quot;Idade (anos)&quot;, y = &quot;Materiais genéticos&quot;) +
 theme_few() +
 scale_fill_viridis(
   name = &quot;Altura dominante (m)&quot;,
   discrete = T, direction = -1
 ) +
 guides(col = guide_legend(reverse = TRUE))</code></pre>
<div class="figure"><span id="fig:6-heatmap-discr-label"></span>
<img src="/post/2016-07-09-os-graficos-que-explicam-nossos-dados-heatmap_files/figure-html/6-heatmap-discr-label-1.png" alt="Aumento da altura dominante utilizando heatmap com escala de cor discreta e informação do valor no grid." width="4000" />
<p class="caption">
Figura  4: Aumento da altura dominante utilizando heatmap com escala de cor discreta e informação do valor no grid.
</p>
</div>
<p>Note que o eixo x é uma variável temporal, entretanto o gráfico não dá a escala entre os anos. Um observador desatento pode achar que as medições ocorreram em intervalos regulares, mas isso não é verdade. Essa é uma desvantagem do heatmap. Quando as variáveis dos eixos são numéricas e representam uma escala comparativa, este atributo fica comprometido.</p>
<p>Caso tenha alguma dúvida ou sugestão sobre o post, fique à vontade para fazer um comentário ou me contatar por E-mail.</p>
<pre class="r"><code>devtools::session_info()</code></pre>
<pre><code>##  setting  value                       
##  version  R version 3.4.3 (2017-11-30)
##  system   x86_64, mingw32             
##  ui       RTerm                       
##  language (EN)                        
##  collate  Portuguese_Brazil.1252      
##  tz       America/Sao_Paulo           
##  date     2018-03-24                  
## 
##  package     * version    date       source                            
##  assertthat    0.2.0      2017-04-11 CRAN (R 3.4.3)                    
##  backports     1.1.2      2017-12-13 CRAN (R 3.4.3)                    
##  base        * 3.4.3      2017-12-06 local                             
##  bindr         0.1.1      2018-03-13 CRAN (R 3.4.4)                    
##  bindrcpp    * 0.2        2017-06-17 CRAN (R 3.4.3)                    
##  blogdown      0.5        2018-01-24 CRAN (R 3.4.4)                    
##  bookdown      0.7        2018-02-18 CRAN (R 3.4.4)                    
##  cli           1.0.0      2017-11-05 CRAN (R 3.4.3)                    
##  colorspace    1.3-2      2016-12-14 CRAN (R 3.4.3)                    
##  compiler      3.4.3      2017-12-06 local                             
##  crayon        1.3.4      2017-09-16 CRAN (R 3.4.3)                    
##  curl          3.1        2017-12-12 CRAN (R 3.4.3)                    
##  datasets    * 3.4.3      2017-12-06 local                             
##  devtools      1.13.5     2018-02-18 CRAN (R 3.4.3)                    
##  digest        0.6.15     2018-01-28 CRAN (R 3.4.3)                    
##  dplyr       * 0.7.4      2017-09-28 CRAN (R 3.4.3)                    
##  evaluate      0.10.1     2017-06-24 CRAN (R 3.4.3)                    
##  ggplot2     * 2.2.1.9000 2018-03-25 Github (tidyverse/ggplot2@3c9c504)
##  ggthemes    * 3.4.0      2017-02-19 CRAN (R 3.4.3)                    
##  glue          1.2.0      2017-10-29 CRAN (R 3.4.3)                    
##  graphics    * 3.4.3      2017-12-06 local                             
##  grDevices   * 3.4.3      2017-12-06 local                             
##  grid          3.4.3      2017-12-06 local                             
##  gridExtra     2.3        2017-09-09 CRAN (R 3.4.3)                    
##  gtable        0.2.0      2016-02-26 CRAN (R 3.4.3)                    
##  highr         0.6        2016-05-09 CRAN (R 3.4.3)                    
##  hms           0.4.2      2018-03-10 CRAN (R 3.4.4)                    
##  htmltools     0.3.6      2017-04-28 CRAN (R 3.4.3)                    
##  knitr         1.20       2018-02-20 CRAN (R 3.4.4)                    
##  labeling      0.3        2014-08-23 CRAN (R 3.4.1)                    
##  lazyeval      0.2.1      2017-10-29 CRAN (R 3.4.3)                    
##  magrittr      1.5        2014-11-22 CRAN (R 3.4.3)                    
##  memoise       1.1.0      2017-04-21 CRAN (R 3.4.3)                    
##  methods     * 3.4.3      2017-12-06 local                             
##  munsell       0.4.3      2016-02-13 CRAN (R 3.4.3)                    
##  pacman      * 0.4.6      2017-05-14 CRAN (R 3.4.3)                    
##  pillar        1.2.1      2018-02-27 CRAN (R 3.4.4)                    
##  pkgconfig     2.0.1      2017-03-21 CRAN (R 3.4.3)                    
##  plyr          1.8.4      2016-06-08 CRAN (R 3.4.3)                    
##  R6            2.2.2      2017-06-17 CRAN (R 3.4.3)                    
##  Rcpp          0.12.16    2018-03-13 CRAN (R 3.4.4)                    
##  readr       * 1.1.1      2017-05-16 CRAN (R 3.4.3)                    
##  rlang         0.2.0.9001 2018-03-25 Github (r-lib/rlang@870a6bf)      
##  rmarkdown     1.9        2018-03-01 CRAN (R 3.4.4)                    
##  rprojroot     1.3-2      2018-01-03 CRAN (R 3.4.3)                    
##  scales        0.5.0.9000 2018-02-11 Github (hadley/scales@d767915)    
##  stats       * 3.4.3      2017-12-06 local                             
##  stringi       1.1.7      2018-03-12 CRAN (R 3.4.4)                    
##  stringr       1.3.0      2018-02-19 CRAN (R 3.4.4)                    
##  tibble        1.4.2      2018-01-22 CRAN (R 3.4.3)                    
##  tools         3.4.3      2017-12-06 local                             
##  utf8          1.1.3      2018-01-03 CRAN (R 3.4.3)                    
##  utils       * 3.4.3      2017-12-06 local                             
##  viridis     * 0.5.0      2018-02-02 CRAN (R 3.4.3)                    
##  viridisLite * 0.3.0      2018-02-01 CRAN (R 3.4.3)                    
##  withr         2.1.2      2018-03-25 Github (jimhester/withr@79d7b0d)  
##  xfun          0.1        2018-01-22 CRAN (R 3.4.4)                    
##  yaml          2.1.18     2018-03-08 CRAN (R 3.4.4)</code></pre>
