---
title: "Gráficos com dimensão espacial e temporal"
date: 2017-07-08
author: Ítalo Cegatta
tags:
  - dplyr
  - sf
  - ggplot2
  - ggthemes
  - geofacet
  - gganimate
  - viridis
  - scales
  - brmap
categories:
  - Gráficos
thumbnailImage: http://i.imgur.com/ZlNUk70.png
coverImage: http://i.imgur.com/ps7MyLH.png
coverCaption:
thumbnailImagePosition: top
metaAlignment: center
coverMeta: out
---



<p>O post de hoje é sobre visualização de dados com dimensão espacial e temporal. Basicamente são gráficos que têm uma representação geográfica associada a informações que variam no tempo. Este tipo de análise é comum no meu dia a dia e por isso resolvi deixar 3 alternativas resgistradas aqui. O contexto que iremos abordar está relacionado ao banco de dados de focos de incêndios registrados pelo INPE no <a href="http://www.inpe.br/queimadas/situacao-atual">Programa Queimadas Monitoramento por Satélites</a>. O site é bem interessante e apresenta algumas estatísticas úteis sobre as queimadas na América do Sul e Brasil. Iremos trabalhar com a tabela que resume os focos de incêndios por ano e Estado brasileiro.</p>
<pre class="r"><code>if (!require(&quot;pacman&quot;)) install.packages(&quot;pacman&quot;)
pacman::p_load(readr, dplyr, sf, ggplot2, ggthemes, geofacet, gganimate, viridis, scales)
pacman::p_load_gh(&quot;italocegatta/brmap&quot;)
pacman::p_load_gh(&quot;dgrtwo/gganimate&quot;)</code></pre>
<p>O primeiro passo foi copiar os dados da página e organizá-los no formato <a href="https://italocegatta.github.io/o-conceito-tidy-data/">tidy</a>. Poderíamos fazer uma análise exploratória dos dados, mas quero manter o foco em algo bem pontual: como mostrar os dados brutos de uma só vez? Ou seja, considerando a dimensão de tempo (ano), geografia (localização do estado) e variável resposta (focos) na mesma janela gráfica, de que forma poderíamos apresentar os dados?</p>
<pre class="r"><code>focos &lt;- read_csv2(&quot;https://raw.githubusercontent.com/italocegatta/italocegatta.github.io_source/master/content/dados/base_incendios.csv&quot;)

focos</code></pre>
<pre><code>## # A tibble: 162 x 3
##    sigla   ano focos
##    &lt;chr&gt; &lt;int&gt; &lt;int&gt;
##  1 AC     2011    13
##  2 AL     2011   127
##  3 AM     2011   159
##  4 AP     2011     5
##  5 BA     2011   883
##  6 CE     2011    44
##  7 DF     2011     8
##  8 ES     2011    55
##  9 GO     2011   492
## 10 MA     2011   656
## # ... with 152 more rows</code></pre>
<p>Vamos agora adicionar a referência espacial aos dados utilizando os polígonos do pacote <a href="https://github.com/italocegatta/brmap">brmap</a>.</p>
<pre class="r"><code>estados_focos &lt;-  focos %&gt;% 
  left_join(brmap_estado, by = &quot;sigla&quot;)

estados_focos</code></pre>
<pre><code>## # A tibble: 162 x 6
##    sigla   ano focos cod_estado estado                            geometry
##    &lt;chr&gt; &lt;int&gt; &lt;int&gt;      &lt;dbl&gt; &lt;chr&gt;                       &lt;POLYGON [Â°]&gt;
##  1 AC     2011    13        12. Acre             ((-73.18253 -7.335496, -~
##  2 AL     2011   127        27. Alagoas          ((-35.46659 -8.817636, -~
##  3 AM     2011   159        13. Amazonas         ((-67.32609 2.029714, -6~
##  4 AP     2011     5        16. Amapá            ((-51.1797 4.000081, -51~
##  5 BA     2011   883        29. Bahia            ((-39.36446 -8.53785, -3~
##  6 CE     2011    44        23. Ceará            ((-40.49717 -2.784509, -~
##  7 DF     2011     8        53. Distrito Federal ((-48.05328 -15.50026, -~
##  8 ES     2011    55        32. Espírito Santo   ((-40.50333 -17.91068, -~
##  9 GO     2011   492        52. Goiás            ((-50.16015 -12.42007, -~
## 10 MA     2011   656        21. Maranhão         ((-45.84073 -1.045485, -~
## # ... with 152 more rows</code></pre>
<p>A primeira abordagem vai utilizar o pacote <a href="https://github.com/hafen/geofacet">geofacet</a>. Ele permite criarmos um grid de referência para orientar a função <code>facet_wrap</code> de <code>ggplot2</code>. O pacote já vem carregado com um grid do Brasil, o <code>br_grid1</code>, mas você pode construir e utilizar seu próprio grid. Eu, particularmente, gosto desta representação pois é extramamente flexível e comporta uma infinidade de gráficos (linhas, pontos, barras…) e dimenções (color, shape, size…). O gráfico <a href="#fig:focos-geofacet">1</a> está bem simples mas cumpre seu papel em facilitar a percepção da variação anual e dar uma noção da região espacial do Estado no Brasil.</p>
<pre class="r"><code>ggplot(estados_focos, aes(ano, focos)) +
  geom_line() +
  facet_geo(~estado, grid = br_grid1) +
  labs(
    x = &quot;Ano&quot;,
    y = &quot;Nº de focos de incêndios&quot;
  ) +
  scale_x_continuous(breaks = 2011:2017, labels = 11:17) +
  scale_y_continuous(label = unit_format(unit = &quot;k&quot;, scale = 1e-3)) +
  theme_few()</code></pre>
<div class="figure"><span id="fig:focos-geofacet"></span>
<img src="/post/2017-07-08-graficos-com-dimensao-espacial-e-temporal_files/figure-html/focos-geofacet-1.png" alt="Representação em painel orientado utilizando linhas." width="4000" />
<p class="caption">
Figura  1: Representação em painel orientado utilizando linhas.
</p>
</div>
<p>A segunda abordagem é relativamente simples e intuitiva. Construiremos um mapa temático utilizando o Nº de focos como escala de cor, mas organizado em um painel que tem como base o ano de registro. O gráfico <a href="#fig:focos-facet">2</a> apela para a dimensão de cor e instantaneamente nos informa o estado mais crítico. Especificamente para esta análise ele este tipo de gráfico é muito apropriado.</p>
<pre class="r"><code>ggplot(estados_focos) +
  geom_sf(aes(fill = focos), color = NA) +
  facet_wrap(~ano) +
  labs(fill = &quot;Nº de focos de incêndios&quot;) +
  scale_fill_viridis(label = unit_format(unit = &quot;k&quot;, scale = 1e-3)) +
  coord_sf(datum = NA) +
  theme_bw() +
  theme(legend.position = &quot;bottom&quot;, legend.justification = &quot;right&quot;) +
  guides(fill = guide_colorbar(barwidth = 15, title.position = &quot;top&quot;))</code></pre>
<div class="figure"><span id="fig:focos-facet"></span>
<img src="/post/2017-07-08-graficos-com-dimensao-espacial-e-temporal_files/figure-html/focos-facet-1.png" alt="Representação em painel utilizando cores." width="4000" />
<p class="caption">
Figura  2: Representação em painel utilizando cores.
</p>
</div>
<p>E por fim, nossa terceira tentativa vai unificar os painéis do gráfico <a href="#fig:focos-facet">2</a> em um gif animado. A limitação do gráfico é que muitas vezes nossos gráficos vão para documentos estáticos como PDF e Word, inviabilizando o gif.</p>
<pre class="r"><code>(ggplot(estados_focos) +
  geom_sf(aes(fill = focos, frame = ano), color = NA) +
  ggtitle(&quot;Ano:&quot;) +
  labs(fill = &quot;Nº de focos de incêndios&quot;) +
  scale_fill_viridis(label = unit_format(unit = &quot;k&quot;, scale = 1e-3)) +
  theme_bw() +
  theme(legend.position = &quot;bottom&quot;, legend.justification = &quot;right&quot;) +
  guides(fill = guide_colorbar(barwidth = 15, title.position = &quot;top&quot;))
  ) %&gt;% 
  gganimate()</code></pre>
<p><a href="http://imgur.com/KoLpSsF"><img src="http://i.imgur.com/KoLpSsF.gif" style="width:100%" /></a></p>
<p>Caso tenha alguma dúvida ou sugestão sobre o post, fique à vontade para fazer um comentário ou me contatar por E-mail.</p>
<pre class="r"><code>devtools::session_info()</code></pre>
<pre><code>##  setting  value                       
##  version  R version 3.4.3 (2017-11-30)
##  system   x86_64, mingw32             
##  ui       RTerm                       
##  language (EN)                        
##  collate  Portuguese_Brazil.1252      
##  tz       America/Sao_Paulo           
##  date     2018-03-24                  
## 
##  package     * version    date       source                             
##  animation     2.5        2017-03-30 CRAN (R 3.4.4)                     
##  assertthat    0.2.0      2017-04-11 CRAN (R 3.4.3)                     
##  backports     1.1.2      2017-12-13 CRAN (R 3.4.3)                     
##  base        * 3.4.3      2017-12-06 local                              
##  base64enc     0.1-3      2015-07-28 CRAN (R 3.4.1)                     
##  bindr         0.1.1      2018-03-13 CRAN (R 3.4.4)                     
##  bindrcpp      0.2        2017-06-17 CRAN (R 3.4.3)                     
##  blogdown      0.5        2018-01-24 CRAN (R 3.4.4)                     
##  bookdown      0.7        2018-02-18 CRAN (R 3.4.4)                     
##  brmap       * 0.0.4      2018-02-11 Github (italocegatta/brmap@af57fd2)
##  class         7.3-14     2015-08-30 CRAN (R 3.4.3)                     
##  classInt      0.1-24     2017-04-16 CRAN (R 3.4.3)                     
##  cli           1.0.0      2017-11-05 CRAN (R 3.4.3)                     
##  colorspace    1.3-2      2016-12-14 CRAN (R 3.4.3)                     
##  compiler      3.4.3      2017-12-06 local                              
##  crayon        1.3.4      2017-09-16 CRAN (R 3.4.3)                     
##  curl          3.1        2017-12-12 CRAN (R 3.4.3)                     
##  datasets    * 3.4.3      2017-12-06 local                              
##  DBI           0.8        2018-03-02 CRAN (R 3.4.4)                     
##  devtools      1.13.5     2018-02-18 CRAN (R 3.4.3)                     
##  digest        0.6.15     2018-01-28 CRAN (R 3.4.3)                     
##  dplyr       * 0.7.4      2017-09-28 CRAN (R 3.4.3)                     
##  e1071         1.6-8      2017-02-02 CRAN (R 3.4.3)                     
##  evaluate      0.10.1     2017-06-24 CRAN (R 3.4.3)                     
##  geofacet    * 0.1.5      2017-07-19 CRAN (R 3.4.4)                     
##  gganimate   * 0.1.0.9000 2018-03-25 Github (dgrtwo/gganimate@bf82002)  
##  ggplot2     * 2.2.1.9000 2018-03-25 Github (tidyverse/ggplot2@3c9c504) 
##  ggthemes    * 3.4.0      2017-02-19 CRAN (R 3.4.3)                     
##  glue          1.2.0      2017-10-29 CRAN (R 3.4.3)                     
##  graphics    * 3.4.3      2017-12-06 local                              
##  grDevices   * 3.4.3      2017-12-06 local                              
##  grid          3.4.3      2017-12-06 local                              
##  gridExtra     2.3        2017-09-09 CRAN (R 3.4.3)                     
##  gtable        0.2.0      2016-02-26 CRAN (R 3.4.3)                     
##  highr         0.6        2016-05-09 CRAN (R 3.4.3)                     
##  hms           0.4.2      2018-03-10 CRAN (R 3.4.4)                     
##  htmltools     0.3.6      2017-04-28 CRAN (R 3.4.3)                     
##  knitr         1.20       2018-02-20 CRAN (R 3.4.4)                     
##  labeling      0.3        2014-08-23 CRAN (R 3.4.1)                     
##  lazyeval      0.2.1      2017-10-29 CRAN (R 3.4.3)                     
##  magrittr      1.5        2014-11-22 CRAN (R 3.4.3)                     
##  memoise       1.1.0      2017-04-21 CRAN (R 3.4.3)                     
##  methods     * 3.4.3      2017-12-06 local                              
##  munsell       0.4.3      2016-02-13 CRAN (R 3.4.3)                     
##  pacman      * 0.4.6      2017-05-14 CRAN (R 3.4.3)                     
##  pillar        1.2.1      2018-02-27 CRAN (R 3.4.4)                     
##  pkgconfig     2.0.1      2017-03-21 CRAN (R 3.4.3)                     
##  plyr          1.8.4      2016-06-08 CRAN (R 3.4.3)                     
##  R6            2.2.2      2017-06-17 CRAN (R 3.4.3)                     
##  Rcpp          0.12.16    2018-03-13 CRAN (R 3.4.4)                     
##  readr       * 1.1.1      2017-05-16 CRAN (R 3.4.3)                     
##  rlang         0.2.0.9001 2018-03-25 Github (r-lib/rlang@870a6bf)       
##  rmarkdown     1.9        2018-03-01 CRAN (R 3.4.4)                     
##  rprojroot     1.3-2      2018-01-03 CRAN (R 3.4.3)                     
##  scales      * 0.5.0.9000 2018-02-11 Github (hadley/scales@d767915)     
##  sf          * 0.6-1      2018-03-22 CRAN (R 3.4.3)                     
##  stats       * 3.4.3      2017-12-06 local                              
##  stringi       1.1.7      2018-03-12 CRAN (R 3.4.4)                     
##  stringr       1.3.0      2018-02-19 CRAN (R 3.4.4)                     
##  tibble        1.4.2      2018-01-22 CRAN (R 3.4.3)                     
##  tools         3.4.3      2017-12-06 local                              
##  udunits2      0.13       2016-11-17 CRAN (R 3.4.1)                     
##  units         0.5-1      2018-01-08 CRAN (R 3.4.3)                     
##  utf8          1.1.3      2018-01-03 CRAN (R 3.4.3)                     
##  utils       * 3.4.3      2017-12-06 local                              
##  viridis     * 0.5.0      2018-02-02 CRAN (R 3.4.3)                     
##  viridisLite * 0.3.0      2018-02-01 CRAN (R 3.4.3)                     
##  withr         2.1.2      2018-03-25 Github (jimhester/withr@79d7b0d)   
##  xfun          0.1        2018-01-22 CRAN (R 3.4.4)                     
##  yaml          2.1.18     2018-03-08 CRAN (R 3.4.4)</code></pre>
